# .github/workflows/deploy.yml
name: Deploy Pixrup

on:
  push:
    branches: [main, stg]

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - branch: main
            env: production
            app_name: pixrup
            app_url: https://pixrup.com
            deploy_path: /var/www/pixrup-prod
            build_cmd: npm run build:prod
            php_fpm: php8.3-fpm
          - branch: stg
            env: stg
            app_name: pixrup_stg
            app_url: https://stg.pixrup.com
            deploy_path: /var/www/pixrup-stg
            build_cmd: npm run build:staging
            php_fpm: php8.3-fpm

    # Ejecutar solo cuando la rama coincide
    if: github.ref_name == matrix.branch
    environment: ${{ matrix.env }}

    steps:
      - name: üß© Checkout
        uses: actions/checkout@v4

      - name: üîê Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DO_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.DO_HOST }} >> ~/.ssh/known_hosts

      - name: üóÑÔ∏è Backup database before deploy
        run: |
          TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }} << EOF
            mkdir -p /var/backups/pixrup
            mysqldump -u${{ secrets.DB_USERNAME }} -p${{ secrets.DB_PASSWORD }} ${{ secrets.DB_DATABASE }} > /var/backups/pixrup/${{ matrix.env }}_\${TIMESTAMP}.sql
          EOF

      - name: üöÄ Deploy Laravel App
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }} << 'EOF'
            set -Eeuo pipefail
            trap 'echo "[deploy] Failed at line $LINENO" >&2' ERR

            cd "${{ matrix.deploy_path }}"
            echo "üå± Deploying ${{ matrix.app_name }} on ${{ matrix.app_url }}"

            git fetch --prune
            git checkout ${{ github.ref_name }}
            git pull --ff-only origin ${{ github.ref_name }}

            echo "üß© Updating dependencies"
            composer install --no-dev --prefer-dist --optimize-autoloader

            echo "‚öôÔ∏è Building frontend"
            npm ci
            ${{ matrix.build_cmd }}

            echo "üîß Generating .env"
            rm -f .env.new
            {
              echo "APP_NAME=${{ matrix.app_name }}"
              if [ "${{ github.ref_name }}" = "main" ]; then
                echo "APP_ENV=production"
                echo "APP_DEBUG=false"
                echo "REDIS_DB=0"
                echo "REDIS_CACHE_DB=1"
              else
                echo "REDIS_DB=2"
                echo "REDIS_CACHE_DB=3"
                echo "APP_ENV=staging"
                echo "APP_DEBUG=true"
                echo "TELESCOPE_ENABLED=true"
                echo "TELESCOPE_PATH=telescope"
                echo "HORIZON_PATH=horizon"
              fi
              echo "APP_URL=${{ matrix.app_url }}"
              echo
              echo "LOG_CHANNEL=stack"
              echo "LOG_LEVEL=debug"
              echo
              echo "DB_CONNECTION=mysql"
              echo "DB_HOST=${{ secrets.DB_HOST }}"
              echo "DB_PORT=3306"
              echo "DB_DATABASE=${{ secrets.DB_DATABASE }}"
              echo "DB_USERNAME=${{ secrets.DB_USERNAME }}"
              echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}"
              echo
              echo "REDIS_HOST=127.0.0.1"
              echo "REDIS_PORT=6379"
              echo "REDIS_DB=${{ matrix.branch == 'main' && '0' || '2' }}"
              echo "REDIS_CACHE_DB=${{ matrix.branch == 'main' && '1' || '3' }}"
              echo
              echo "GOOGLE_CLIENT_ID=${{ vars.GOOGLE_CLIENT_ID }}"
              echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}"
              echo "GOOGLE_REDIRECT_URI=${{ vars.GOOGLE_REDIRECT_URI }}"
              echo "VITE_GOOGLE_MAPS_KEY=${{ secrets.VITE_GOOGLE_MAPS_KEY }}"
              echo "APPRAISAL_PROVIDER=${{ vars.APPRAISAL_PROVIDER }}"
            } > .env.new

            # Preserve existing APP_KEY if present
            if [ -f .env ] && grep -q '^APP_KEY=' .env; then
              grep '^APP_KEY=' .env >> .env.new
            fi
            mv .env.new .env
            php artisan key:generate --force || true

            echo "üöÄ Running migrations and caches"
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan storage:link 2>/dev/null || true

            if [ "${{ github.ref_name }}" = "stg" ]; then
              echo "üîç Enabling Telescope and Horizon (staging)"
              php artisan telescope:publish --ansi || true
              sudo systemctl restart horizon-stg
            else
              echo "üß± Production mode ‚Äî Horizon worker active"
              sudo systemctl restart horizon-prod
            fi

            sudo systemctl restart ${{ matrix.php_fpm }}

            echo "‚úÖ Deploy completed successfully!"
          EOF

      - name: ü©∫ Health check
        run: |
          echo "Verifying that ${{ matrix.app_url }} is live..."
          curl -fsS -o /dev/null ${{ matrix.app_url }}

      - name: üì£ Notify success
        if: success()
        run: |
          echo "‚úÖ Deployment successful for ${{ matrix.env }}"
          # Optional: send webhook notification (Slack, Discord, etc.)
          # curl -X POST -H 'Content-type: application/json' \
          #      --data '{"text": "‚úÖ Pixrup deployed successfully to '${{ matrix.env }}'."}' \
          #      ${{ secrets.SLACK_WEBHOOK_URL }}
