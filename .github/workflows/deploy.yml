name: Deploy Pixrup

on:
  push:
    branches: [main, stg]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ matrix.env }}
    strategy:
      matrix:
        include:
          - branch: stg
            env: staging
            deploy_path: /var/www/pixrup-stg
            php_fpm: php8.3-fpm
            build_cmd: npm run build:staging
            app_name: pixrup_stg
            app_url: https://stg.pixrup.com
          - branch: main
            env: production
            deploy_path: /var/www/pixrup-prod
            php_fpm: php8.3-fpm
            build_cmd: npm run build:prod
            app_name: pixrup
            app_url: https://pixrup.com

    # ‚úÖ esta es la forma correcta de filtrar por rama
    if: contains(fromJson('["main","stg"]'), github.ref_name)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DO_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.DO_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no ${{ vars.DO_USER }}@${{ secrets.DO_HOST }} << 'EOF'
            set -Eeuo pipefail
            trap 'echo "[deploy] Failed at line $LINENO" >&2' ERR

            cd "${{ matrix.deploy_path }}"
            echo "üå± Deploying ${{ matrix.app_name }} on ${{ matrix.app_url }}"
            git fetch --prune
            git checkout ${{ matrix.branch }}
            git pull --ff-only origin ${{ matrix.branch }}

            echo "üß© Updating dependencies"
            composer install --no-dev --prefer-dist --optimize-autoloader

            echo "‚öôÔ∏è Building frontend"
            npm ci
            ${{ matrix.build_cmd }}

            echo "üîß Generating .env"
            rm -f .env.new
            {
              echo "APP_NAME=${{ matrix.app_name }}"
              if [ "${{ matrix.branch }}" = "main" ]; then
                echo "APP_ENV=production"
                echo "APP_DEBUG=false"
                echo "REDIS_DB=0"
                echo "REDIS_CACHE_DB=1"
              else
                echo "APP_ENV=staging"
                echo "APP_DEBUG=true"
                echo "REDIS_DB=2"
                echo "REDIS_CACHE_DB=3"
                echo "TELESCOPE_ENABLED=true"
                echo "TELESCOPE_PATH=telescope"
                echo "HORIZON_PATH=horizon"
              fi
              echo "APP_URL=${{ matrix.app_url }}"
              echo
              echo "LOG_CHANNEL=stack"
              echo "LOG_LEVEL=debug"
              echo
              echo "DB_CONNECTION=mysql"
              echo "DB_HOST=${{ secrets.DB_HOST }}"
              echo "DB_PORT=3306"
              echo "DB_DATABASE=${{ secrets.DB_DATABASE }}"
              echo "DB_USERNAME=${{ secrets.DB_USERNAME }}"
              echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}"
              echo
              echo "GOOGLE_CLIENT_ID=${{ vars.GOOGLE_CLIENT_ID }}"
              echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}"
              echo "GOOGLE_REDIRECT_URI=${{ vars.GOOGLE_REDIRECT_URI }}"
              echo "VITE_GOOGLE_MAPS_KEY=${{ secrets.VITE_GOOGLE_MAPS_KEY }}"
              echo "APPRAISAL_PROVIDER=${{ vars.APPRAISAL_PROVIDER }}"
            } > .env.new

            # Preserve APP_KEY
            if [ -f .env ] && grep -q '^APP_KEY=' .env; then
              grep '^APP_KEY=' .env >> .env.new
            fi
            mv .env.new .env
            php artisan key:generate --force || true

            echo "üöÄ Running migrations and caches"
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan storage:link 2>/dev/null || true

            if [ "${{ matrix.branch }}" = "stg" ]; then
              echo "üîç Restarting Horizon (staging)"
              sudo systemctl restart horizon-stg
            else
              echo "üß± Restarting Horizon (production)"
              sudo systemctl restart horizon-prod
            fi

            sudo systemctl restart ${{ matrix.php_fpm }}

            echo "‚úÖ Deploy completed successfully!"
          EOF
